# HumanLayer Web UI (`humanlayer_wui`) Summary

This document provides a detailed summary of the `humanlayer_wui` subdirectory, which contains the Web User Interface and Desktop Application for the HumanLayer project.

## 1. Overview
The `humanlayer_wui` directory houses the frontend application for HumanLayer. It is a modern React-based application wrapped in Tauri to provide a native desktop experience. It serves as the primary interface for users to interact with the HumanLayer Daemon (`hld`), manage sessions, view conversation history, and handle approvals for autonomous actions.

## 2. Technology Stack
*   **Frontend Framework**: React (v18+) with TypeScript.
*   **Build Tool**: Vite.
*   **Desktop Framework**: Tauri (v2) using Rust for the backend process.
*   **Styling**: Tailwind CSS (v4), with custom terminal-inspired themes (Solarized, Catppuccin, Gruvbox, etc.).
*   **State Management**: Zustand.
*   **Routing**: React Router DOM (HashRouter).
*   **Component Development**: Storybook.
*   **Editor**: Tiptap (for rich text input).
*   **Testing**: Jest, React Testing Library.
*   **Communication**: JSON-RPC over Unix Sockets (via `@humanlayer/hld-sdk`).

## 3. Directory Structure

### Root Level
*   `.storybook/`: Storybook configuration and preview setups.
*   `docs/`: Documentation for API, Architecture, Developer Guide, and Hotkeys.
*   `src/`: Main frontend source code.
*   `src-tauri/`: Tauri (Rust) backend source code.
*   `src-tauri/capabilities/`: Tauri capability definitions.
*   `src-tauri/icons/`: Application icons.

### `src/` Directory
*   **`components/`**: Reusable React components.
    *   `internal/`: Core business logic components.
        *   `ConversationStream/`: Components for rendering the chat history (messages, tool calls, diffs).
        *   `SessionDetail/`: Components specific to the session view (input, action buttons, status bar).
    *   `ui/`: Generic UI components (buttons, inputs, dialogs, etc.), likely based on shadcn/ui or similar.
    *   `Layout.tsx`: Main application layout.
    *   `QuickLauncher.tsx`: Component for quickly starting new sessions.
*   **`hooks/`**: Custom React hooks.
    *   `useApprovals.ts`: Manages approval requests.
    *   `useConversation.ts`: Fetches and manages conversation history.
    *   `useSessions.ts`: Manages the list of sessions.
    *   `useDaemonConnection.ts`: Monitors connection to the `hld` daemon.
*   **`lib/`**: Core libraries and utilities.
    *   `daemon/`: Client for communicating with the HumanLayer Daemon.
    *   `telemetry/`: Telemetry integration (PostHog, Sentry).
*   **`pages/`**: Top-level page components.
    *   `SessionTablePage.tsx`: The home page listing sessions.
    *   `SessionDetailPage.tsx`: The active session view.
    *   `DraftSessionPage.tsx`: Page for creating new sessions.
*   **`services/`**: Singleton services.
    *   `daemon-service.ts`: Service for daemon interaction.
    *   `NotificationService.tsx`: Handles system notifications.
*   **`stores/`**: Global state management (Zustand).
    *   `appStore.ts`: The primary store for application state.
*   **`styles/`**: Global styles and theme definitions.
*   **`types/`**: TypeScript type definitions.
*   **`utils/`**: Helper functions (formatting, validation, etc.).
*   **`router.tsx`**: Application routing configuration.

### `src-tauri/` Directory
*   **`src/lib.rs`**: Main entry point for the Tauri backend library. Handles window customization and daemon management.
*   **`src/daemon.rs`**: Logic for spawning and managing the `hld` process.

## 4. Key Components & Features

### Session Management
*   **Session Table**: Displays a list of active and archived sessions with their status and summary.
*   **Quick Launcher**: A modal/page to quickly start a new session with a query and optional parameters (model, working directory).
*   **Draft Mode**: Allows users to compose a session request before launching it.

### Conversation Interface (`SessionDetail`)
*   **Conversation Stream**: Renders a linear history of user messages, agent thoughts, tool calls, and outputs.
*   **Diff Viewer**: A specialized component for visualizing code changes (diffs) generated by the agent.
*   **Input Area**: A rich text editor (Tiptap) for sending messages to the agent.
*   **Auto-Scroll**: Smart auto-scrolling behavior that respects user interaction.

### Approvals System
*   **Unified Approvals**: The UI handles various types of approvals (function calls, human contact) in a unified way.
*   **Decision UI**: Users can approve or deny actions directly from the conversation stream or a dedicated approval list.

### Theming
*   **Terminal Themes**: The app supports multiple themes (Solarized, Catppuccin, Monokai, etc.) that mimic popular terminal color schemes.
*   **Dynamic Backgrounds**: On macOS, the window background color is dynamically updated to match the selected theme for a seamless look.

## 5. Data Model

### Session
Extends the SDK `Session` type with UI-specific properties.
*   `id`: Unique identifier.
*   `status`: Current state (Running, Paused, Error, etc.).
*   `query`: The initial user query.
*   `workingDir`: The directory where the session is running.
*   `additionalDirectories`: Extra directories accessible to the session.

### Approval
Represents a request for user permission.
*   `id`: Unique identifier.
*   `type`: Type of approval (e.g., `tool_call`).
*   `tool`: Name of the tool being called.
*   `parameters`: Arguments for the tool.

### ConversationEvent
Represents a single event in the chat history.
*   Types include: `UserMessage`, `AssistantMessage`, `ToolCall`, `ToolResult`, `Error`.

## 6. State Management (`appStore`)
The `appStore` is the central source of truth for the frontend.
*   **Sessions**: Maintains the list of all sessions and the currently focused session.
*   **Active Session Detail**: Caches the details and conversation history of the active session to avoid refetching.
*   **Approvals**: Tracks pending approvals.
*   **UI State**: Manages loading states, active modals, and the response editor instance.
*   **Actions**: Provides methods to update sessions, handle approvals, and manage UI state.

## 7. Architecture & Communication
*   **Frontend-Backend Bridge**: The frontend communicates with the local `hld` daemon via a Unix Socket.
*   **Tauri Bridge**: The frontend uses Tauri commands to interact with the OS (window management, file system) and to manage the daemon process itself.
*   **Polling/Subscription**: The app uses a combination of polling and event subscriptions (via the daemon client) to stay in sync with the backend state.

## 8. Development & Testing
*   **Storybook**: Used extensively for developing and testing UI components in isolation.
*   **Mocking**: `test-utils.ts` provides mock data generators (e.g., `createMockSession`) for testing.
*   **Demos**: The app includes several demo pages (`/_store_demo`, `/_wui_demo`) to showcase component functionality and state management.
