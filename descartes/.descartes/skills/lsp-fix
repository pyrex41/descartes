#!/bin/bash
# lsp-fix - Get LSP diagnostics and ask OpenCode to fix them
#
# Usage: lsp-fix <file> [--dry-run]
#
# This skill:
# 1. Runs LSP diagnostics on the file
# 2. If errors found, sends them to OpenCode with the file content
# 3. OpenCode suggests or applies fixes

set -e

FILE=""
DRY_RUN=""

# Parse args
while [[ $# -gt 0 ]]; do
    case $1 in
        --dry-run)
            DRY_RUN="true"
            shift
            ;;
        -h|--help)
            echo "Usage: lsp-fix <file> [--dry-run]"
            echo ""
            echo "Get LSP diagnostics and ask OpenCode to fix them."
            echo ""
            echo "Options:"
            echo "  --dry-run   Show what would be fixed without making changes"
            echo "  -h, --help  Show this help"
            echo ""
            echo "Examples:"
            echo "  lsp-fix src/main.rs"
            echo "  lsp-fix app.tsx --dry-run"
            exit 0
            ;;
        *)
            if [ -z "$FILE" ]; then
                FILE="$1"
            fi
            shift
            ;;
    esac
done

if [ -z "$FILE" ]; then
    echo "Error: No file provided"
    echo "Usage: lsp-fix <file> [--dry-run]"
    exit 1
fi

if [ ! -f "$FILE" ]; then
    echo "Error: File not found: $FILE"
    exit 1
fi

# Check if opencode is available
if ! command -v opencode &> /dev/null; then
    echo "Error: opencode not found in PATH"
    exit 1
fi

echo "Checking $FILE for LSP diagnostics..."
echo "---"

# Get diagnostics
DIAGNOSTICS=$(opencode debug lsp diagnostics "$FILE" 2>&1) || true

if echo "$DIAGNOSTICS" | grep -q "No diagnostics"; then
    echo "No issues found!"
    exit 0
fi

echo "Found issues:"
echo "$DIAGNOSTICS"
echo "---"

if [ -n "$DRY_RUN" ]; then
    echo "[Dry run] Would ask OpenCode to fix these issues"
    exit 0
fi

# Build prompt with diagnostics
PROMPT="Fix the following LSP diagnostics in $FILE:

$DIAGNOSTICS

Please fix all the errors and warnings. Show me the corrected code."

# Check for running server
ATTACH_URL=""
PIDFILE="/tmp/opencode-server.pid"
if [ -f "$PIDFILE" ] && kill -0 "$(cat $PIDFILE)" 2>/dev/null; then
    ATTACH_URL="--attach http://${OPENCODE_HOST:-127.0.0.1}:${OPENCODE_PORT:-4096}"
fi

echo "Asking OpenCode to fix..."
echo "---"

opencode run $ATTACH_URL -q "$PROMPT"

echo "---"
echo "Skill: lsp-fix"
